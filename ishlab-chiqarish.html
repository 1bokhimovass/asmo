<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ishlab chiqarish - ASMO AVTO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>
    <style>
      :root {
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
      }
      body {
        background-color: var(--bg-color);
        font-family: "Segoe UI", sans-serif;
        padding-bottom: 50px;
      }
      .card-form {
        border-radius: 20px;
        border: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      }
      .dynamic-row {
        background: #f1f3f5;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 5px solid #0d6efd;
      }
      .form-label {
        font-size: 0.8rem;
        font-weight: bold;
        color: #555;
      }
      .price-auto {
        background-color: #e9ecef !important;
        font-weight: bold;
        color: #d63384 !important;
      }
      .table-custom {
        background: white;
        border-radius: 15px;
        overflow: hidden;
      }
      /* Rasmda ko'rsatilgan yozuv uslublari */
      .text-qty {
        color: #007f5f;
        font-weight: bold;
        font-size: 1.1rem;
      }
      .text-code-size {
        color: #6c757d;
        font-size: 0.9rem;
      }
      .text-total {
        color: #2b6cb0;
        font-weight: bold;
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="row justify-content-center">
        <div class="col-12 col-md-9 col-lg-8">
          <div class="card card-form p-4 mb-4">
            <h4 class="text-center fw-bold mb-4 text-primary">
              üèóÔ∏è GORE-TEX ISHLAB CHIQARISH
            </h4>

            <div class="mb-3">
              <label class="form-label">Partiya raqami (Batch ID)</label>
              <input
                type="text"
                id="batch_id"
                class="form-control fw-bold border-primary"
                placeholder="#P-2026"
              />
            </div>

            <div id="dynamic_rows_container">
              <div class="dynamic-row">
                <div class="mb-2">
                  <label class="form-label">O'lcham va Kodni tanlang</label>
                  <select
                    class="form-select gore-item-select fw-bold"
                    onchange="handleSizeChange(this)"
                  >
                    <option value="" disabled selected hidden>
                      -- Tanlang --
                    </option>
                    <option value="12.7mm|VE0017GMK">12.7mm - VE0017GMK</option>
                    <option value="12.7mm|VE001VAP">12.7mm - VE001VAP</option>
                    <option value="19.5mm|VE2004">19.5mm - VE2004</option>
                    <option value="40.20mm|VE0020GMC">
                      40.20mm - VE0020GMC
                    </option>
                    <option value="27.27mm|VE2084">27.27mm - VE2084</option>
                  </select>
                </div>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label">Miqdori (dona)</label>
                    <input
                      type="number"
                      class="form-control gore-item-qty fw-bold border-success"
                      placeholder="0"
                    />
                  </div>
                  <div class="col-6">
                    <label class="form-label">Dona narxi (Aniq)</label>
                    <input
                      type="text"
                      class="form-control gore-item-price price-auto"
                      readonly
                      placeholder="0.00"
                    />
                  </div>
                </div>
              </div>
            </div>

            <button
              class="btn btn-outline-primary btn-sm w-100 mb-4 fw-bold"
              onclick="addNewRow()"
            >
              + YANA RAZMER QO'SHISH
            </button>
            <button
              class="btn btn-success btn-lg w-100 fw-bold shadow"
              onclick="saveAll()"
            >
              ‚úÖ BARCHASINI SAQLASH
            </button>
          </div>

          <div class="table-responsive">
            <table class="table table-custom align-middle shadow-sm">
              <thead class="table-dark">
                <tr>
                  <th>Batch / Vaqt</th>
                  <th>Miqdor x Narx</th>
                  <th>Jami Summa</th>
                </tr>
              </thead>
              <tbody id="archive-table"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      const gorePrices = {
        "12.7mm|VE0017GMK": 1273.68,
        "12.7mm|VE001VAP": 1188.81,
        "19.5mm|VE2004": 3134.15,
        "40.20mm|VE0020GMC": 4539.11,
        "27.27mm|VE2084": 4353.73,
      };

      function handleSizeChange(selectElement) {
        const row = selectElement.closest(".dynamic-row");
        const priceInput = row.querySelector(".gore-item-price");
        priceInput.value = gorePrices[selectElement.value] || "";
      }

      function addNewRow() {
        const container = document.getElementById("dynamic_rows_container");
        const div = document.createElement("div");
        div.className = "dynamic-row";
        div.innerHTML = `
            <div class="mb-2">
                <label class="form-label">O'lcham va Kodni tanlang</label>
                <select class="form-select gore-item-select fw-bold" onchange="handleSizeChange(this)">
                    <option value="" disabled selected hidden>-- Tanlang --</option>
                    <option value="12.7mm|VE0017GMK">12.7mm - VE0017GMK</option>
                    <option value="12.7mm|VE001VAP">12.7mm - VE001VAP</option>
                    <option value="19.5mm|VE2004">19.5mm - VE2004</option>
                    <option value="40.20mm|VE0020GMC">40.20mm - VE0020GMC</option>
                    <option value="27.27mm|VE2084">27.27mm - VE2084</option>
                </select>
            </div>
            <div class="row g-2">
                <div class="col-6">
                    <label class="form-label">Miqdori (dona)</label>
                    <input type="number" class="form-control gore-item-qty fw-bold border-success" placeholder="0">
                </div>
                <div class="col-6">
                    <label class="form-label">Dona narxi (Aniq)</label>
                    <input type="text" class="form-control gore-item-price price-auto" readonly placeholder="0.00">
                </div>
            </div>`;
        container.appendChild(div);
      }

      async function saveAll() {
        const batch = document.getElementById("batch_id").value.trim();
        if (!batch) return alert("Partiya raqamini kiriting!");

        const selects = document.querySelectorAll(".gore-item-select");
        const qtys = document.querySelectorAll(".gore-item-qty");
        const prices = document.querySelectorAll(".gore-item-price");

        let records = [];
        for (let i = 0; i < selects.length; i++) {
          if (selects[i].value && qtys[i].value > 0) {
            const [size, code] = selects[i].value.split("|");
            const price = parseFloat(prices[i].value);
            const qty = parseInt(qtys[i].value);
            const jami = (qty * price).toFixed(2);

            records.push({
              size,
              code,
              qty,
              price,
              jami_summa: parseFloat(jami),
            });
          }
        }

        if (records.length === 0) return alert("Ma'lumotlar chala!");

        const timeNow = new Date().toLocaleString("uz-UZ", {
          hour: "2-digit",
          minute: "2-digit",
          day: "2-digit",
          month: "2-digit",
        });

        try {
          for (let rec of records) {
            await db.ref("asmo_all_history").push({
              product: "GORE-TEX PATCH",
              batch,
              ...rec,
              time: timeNow,
              timestamp: Date.now(),
            });
          }
          alert("‚úÖ Saqlandi!");
          location.reload();
        } catch (e) {
          alert("Xatolik: " + e.message);
        }
      }

      function loadRecords() {
        db.ref("asmo_all_history")
          .limitToLast(20)
          .on("value", (snap) => {
            const table = document.getElementById("archive-table");
            table.innerHTML = "";
            const data = snap.val();
            if (data) {
              Object.values(data)
                .filter((i) => i.product === "GORE-TEX PATCH")
                .reverse()
                .forEach((item) => {
                  const formatSumma = item.jami_summa.toLocaleString("uz-UZ", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  });

                  // Jadvaldagi ko'rinishni rasmga asosan o'zgartiramiz
                  table.innerHTML += `
                    <tr>
                        <td><b>${item.batch}</b><br><small class="text-muted">${item.time}</small></td>
                        <td>
                            <span class="text-qty">${item.qty} dona</span> x ${item.price}<br>
                            <span class="text-code-size">${item.code} / ${item.size}</span>
                        </td>
                        <td class="text-total text-nowrap">${formatSumma} so'm</td>
                    </tr>`;
                });
            }
          });
      }

      window.onload = loadRecords;
    </script>
  </body>
</html>
