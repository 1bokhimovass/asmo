<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Ishlab chiqarish - ASMO AVTO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="config.js"></script>

    <style>
      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", sans-serif;
        padding-bottom: 50px;
      }
      .header-fixed {
        position: sticky;
        top: 0;
        background: white;
        z-index: 1000;
        border-bottom: 1px solid #eee;
        padding: 12px 0;
      }
      .back-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        background: white;
        color: #333;
        text-decoration: none;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        border: none;
        margin-right: 15px;
      }
      .back-btn:hover {
        background: #f8f9fa;
        transform: scale(1.05);
        color: #000;
      }
      .back-btn:active {
        transform: scale(0.9);
      }
      .card-form {
        border-radius: 20px;
        border: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      }
      .form-label {
        font-size: 0.85rem;
        color: #555;
        margin-bottom: 4px;
      }

      @media (max-width: 768px) {
        .table-responsive thead {
          display: none;
        }
        .table-responsive tr {
          display: block;
          border: none;
          margin-bottom: 15px;
          background: #fff;
          border-radius: 15px;
          padding: 10px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .table-responsive td {
          display: flex;
          justify-content: space-between;
          border: none;
          padding: 5px 10px;
          font-size: 0.9rem;
        }
        .table-responsive td::before {
          content: attr(data-label);
          font-weight: bold;
          color: #777;
        }
      }
    </style>
  </head>
  <body>
    <header class="header-fixed shadow-sm">
      <div class="container d-flex align-items-center">
        <a href="index.html" class="back-btn">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            fill="currentColor"
            viewBox="0 0 16 16"
          >
            <path
              fill-rule="evenodd"
              d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"
            />
          </svg>
        </a>
        <h5 class="fw-bold mb-0">
          üèóÔ∏è <span id="page-title">Yuklanmoqda...</span>
        </h5>
      </div>
    </header>

    <div class="container py-3">
      <div class="row">
        <div class="col-12 col-lg-4 mb-4">
          <div class="card card-form p-3 p-md-4">
            <h5 class="fw-bold text-center mb-3">Ma'lumot Kiritish</h5>

            <select id="prod_select" style="display: none">
              <option value="GORE-TEX PATCH">Gore-Tex Patch</option>
              <option value="LED PCB">LED PCB</option>
              <option value="AVTO SWITCH">Avto Switch</option>
            </select>

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label fw-bold">Partiya (Batch ID)</label>
                <input
                  type="text"
                  id="batch_id"
                  class="form-control"
                  placeholder="#P-2025"
                />
              </div>
              <div class="col-6" id="olcham_wrapper">
                <label class="form-label fw-bold">O'lchami</label>
                <input
                  type="text"
                  id="olcham_id"
                  class="form-control"
                  placeholder="Masalan: 25"
                />
              </div>
              <div class="col-6">
                <label class="form-label fw-bold">Tayyor (dona)</label>
                <input
                  type="number"
                  id="prod_qty"
                  class="form-control border-success"
                  placeholder="0"
                />
              </div>
              <div class="col-6">
                <label class="form-label fw-bold text-danger"
                  >Brak (dona)</label
                >
                <input
                  type="number"
                  id="scrap_qty"
                  class="form-control border-danger"
                  value="0"
                />
              </div>
              <div class="col-12">
                <label class="form-label fw-bold text-primary"
                  >1 dona narxi (so'm)</label
                >
                <input
                  type="number"
                  id="unit_price"
                  class="form-control border-primary"
                  placeholder="Narxni kiriting"
                  value="0"
                />
              </div>
            </div>

            <button
              style="margin-top: 15px"
              id="save_btn"
              class="btn btn-primary w-100 fw-bold shadow"
              onclick="addRecord()"
            >
              SAQLASH
            </button>
          </div>
        </div>

        <div class="col-12 col-lg-8">
          <h6
            class="fw-bold mb-3 text-uppercase text-muted"
            style="letter-spacing: 1px"
          >
            üìú Oxirgi amallar
          </h6>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Vaqt / Mahsulot</th>
                  <th id="th_olcham">O'lchami</th>
                  <th>ID</th>
                  <th>Tayyor</th>
                  <th>Brak</th>
                  <th>Summa</th>
                </tr>
              </thead>
              <tbody id="archive-table"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentProduct = "";

      window.onload = function () {
        const savedType = localStorage.getItem("selectedProduct");
        const olchamWrapper = document.getElementById("olcham_wrapper");
        const pageTitleEl = document.getElementById("page-title");

        // Mahsulotni localStorage ga qarab ANIQ belgilaymiz
        if (savedType === "Gore") {
          currentProduct = "GORE-TEX PATCH";
          olchamWrapper.style.display = "block";
        } else if (savedType === "LED") {
          currentProduct = "LED PCB";
          olchamWrapper.style.display = "none";
        } else if (savedType === "Switch") {
          currentProduct = "AVTO SWITCH";
          olchamWrapper.style.display = "none";
        } else {
          window.location.href = "index.html";
          return;
        }

        // Sarlavhani o'rnatamiz
        pageTitleEl.innerText = currentProduct + " : Ishlab chiqarish";

        // Tarixni yuklaymiz
        loadLastRecords();
      };

      function addRecord() {
        const saveBtn = document.getElementById("save_btn");
        const batch = document.getElementById("batch_id").value.trim();
        const qty = parseInt(document.getElementById("prod_qty").value);
        const scrap = parseInt(document.getElementById("scrap_qty").value) || 0;
        const price =
          parseFloat(document.getElementById("unit_price").value) || 0;
        const olcham = document.getElementById("olcham_id").value.trim();

        if (!batch || isNaN(qty) || qty <= 0)
          return alert("Ma'lumotlarni to'liq kiriting!");

        saveBtn.disabled = true;
        saveBtn.innerText = "SAQLANMOQDA...";

        const totalSum = qty * price;
        const record = {
          time: new Date().toLocaleString("uz-UZ", {
            hour: "2-digit",
            minute: "2-digit",
            day: "2-digit",
            month: "2-digit",
          }),
          product: currentProduct,
          batch: batch,
          qty: qty,
          scrap: scrap,
          price: price,
          total: totalSum,
          olcham: currentProduct === "GORE-TEX PATCH" ? olcham : "-",
        };

        db.ref("asmo_all_history")
          .push(record)
          .then(() => {
            const zaxiraRef = db.ref(
              "asmo_tayyor_mahsulot_zaxirasi/" + currentProduct
            );
            zaxiraRef.once("value").then((snap) => {
              const currentTotal = snap.val() || 0;
              zaxiraRef.set(currentTotal + qty).then(() => {
                alert("‚úÖ " + currentProduct + " uchun saqlandi!");
                document.getElementById("batch_id").value = "";
                document.getElementById("prod_qty").value = "";
                document.getElementById("scrap_qty").value = "0";
                document.getElementById("unit_price").value = "0";
                document.getElementById("olcham_id").value = "";
              });
            });
          })
          .catch((err) => alert("Xato: " + err.message))
          .finally(() => {
            saveBtn.disabled = false;
            saveBtn.innerText = "SAQLASH";
          });
      }

      function loadLastRecords() {
        db.ref("asmo_all_history")
          .limitToLast(50)
          .on("value", (snapshot) => {
            const table = document.getElementById("archive-table");
            const thOlcham = document.getElementById("th_olcham");
            table.innerHTML = "";

            // Ustunni ko'rsatish yoki yashirish
            thOlcham.style.display =
              currentProduct === "GORE-TEX PATCH" ? "" : "none";

            const data = snapshot.val();
            if (data) {
              // FAQAT joriy mahsulotni filtrlaymiz
              Object.values(data)
                .filter((item) => item.product === currentProduct)
                .reverse()
                .forEach((item) => {
                  let olchamCell =
                    currentProduct === "GORE-TEX PATCH"
                      ? `<td data-label="O'lchami"><span class="badge bg-info text-dark border">${
                          item.olcham || "-"
                        }</span></td>`
                      : "";

                  table.innerHTML += `
                  <tr>
                    <td data-label="Mahsulot"><small class="text-muted d-block">${
                      item.time
                    }</small><span class="fw-bold text-primary">${
                    item.product
                  }</span></td>
                    ${olchamCell}
                    <td data-label="Batch"><span class="badge bg-light text-dark border">${
                      item.batch
                    }</span></td>
                    <td data-label="Tayyor" class="text-success fw-bold">${
                      item.qty
                    }</td>
                    <td data-label="Brak" class="text-danger fw-bold">${
                      item.scrap
                    }</td>
                    <td data-label="Summa" class="fw-bold text-dark">${(
                      item.total || 0
                    ).toLocaleString()} so'm</td>
                  </tr>`;
                });
            }
          });
      }
    </script>
  </body>
</html>
